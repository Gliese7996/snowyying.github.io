<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SELECT是如何实现的？ | Snowyying</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="转自: http://www.quora.com/Network-Programming/How-is-select-implemented 2012-11-28

我会以Linux为例，因为那是我熟悉的。我没有BSD或其他unix系统的经验，但我假定这些系统原理上类似。
每一个Socket（实际上可以是能够注册到select()上的任意fd - file descriptor）都有一个wait">
<meta property="og:type" content="article">
<meta property="og:title" content="SELECT是如何实现的？">
<meta property="og:url" content="http://yoursite.com/2016/08/02/select-implement/index.html">
<meta property="og:site_name" content="Snowyying">
<meta property="og:description" content="转自: http://www.quora.com/Network-Programming/How-is-select-implemented 2012-11-28

我会以Linux为例，因为那是我熟悉的。我没有BSD或其他unix系统的经验，但我假定这些系统原理上类似。
每一个Socket（实际上可以是能够注册到select()上的任意fd - file descriptor）都有一个wait">
<meta property="og:updated_time" content="2016-08-02T13:25:41.794Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SELECT是如何实现的？">
<meta name="twitter:description" content="转自: http://www.quora.com/Network-Programming/How-is-select-implemented 2012-11-28

我会以Linux为例，因为那是我熟悉的。我没有BSD或其他unix系统的经验，但我假定这些系统原理上类似。
每一个Socket（实际上可以是能够注册到select()上的任意fd - file descriptor）都有一个wait">
  
    <link rel="alternate" href="/atom.xml" title="Snowyying" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Snowyying</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Learn and live.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-select-implement" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/02/select-implement/" class="article-date">
  <time datetime="2016-08-02T13:21:47.000Z" itemprop="datePublished">2016-08-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SELECT是如何实现的？
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>转自: <a href="http://www.quora.com/Network-Programming/How-is-select-implemented" target="_blank" rel="external">http://www.quora.com/Network-Programming/How-is-select-implemented</a> 2012-11-28</p>
</blockquote>
<p>我会以Linux为例，因为那是我熟悉的。我没有BSD或其他unix系统的经验，但我假定这些系统原理上类似。</p>
<p>每一个Socket（实际上可以是能够注册到select()上的任意fd - file descriptor）都有一个waiters的列表，他们（waiter）在等待socket上的活动（在linux上是 struct wait_queue_head_t）。这个Socket上无论什么时候有感兴趣的事件发生（到达新数据，缓冲区有可写的空闲空间，或者某种错误），这个Socket会遍历列表通知等待活动的每一个线程。</p>
<p>select()系统调用遍历用户传入的描述符列表。对于每一个fd，调用fd的poll()方法（这个方法和应用层的poll()系统调用是两回事），这将会添加调用者（当前线程）到fd的等待队列，返回适用于当前fd的事件（读，写，异常）。</p>
<p>如果任何fd匹配用户传入的条件，select()在更新用户传入的fd_sets后，立即返回。</p>
<p>如果没有匹配的fd，select()会一直休眠，一直到用户指定的最大超时时间。</p>
<p>如果在超时时间间隔内，注册到select()上的任一fd有感兴趣的事件发生，fd会通知这个fd的等待队列。这会唤醒调用select()时休眠的用户线程，这时就会重复上面的循环，看看哪一个fd准备好返回给用户。</p>
<p>select()会记录它添加的所有的等待队列，在返回以前，确保从所有的fd移除。</p>
<p>summary：每一次select()调用需要 3 次遍历，第一次是对每个fd分别调用poll，第二次是遍历生成返回给用户的fd_sets，第三次是应用层面遍历进行业务逻辑处理。</p>
<p>英文原文：</p>
<p>I’ll answer for Linux, since that’s what I know. I have no experience with any of the BSDs or other unixes, but I would assume they work broadly similarly.</p>
<p>Every socket (really, every file descriptor that can be select()ed on) has a list of waiters that are currently waiting for activity on that socket (struct wait_queue_head_t in Linux terminology). Whenever something interesting happens on that socket (new data is available, buffer space is free for writing, or some kind of error), that socket will walk its list and notify everyone waiting on it.</p>
<p>select() works by looping over the list of file descriptors that the user passed in. For every file descriptor, it calls that fd’s poll() method, which will add the caller to that fd’s wait queue, and return which events (readable, writeable, exception) currently apply to that fd.</p>
<p>If any file descriptor matches the condition that the user was looking for, select() will simply return immediately, after updating the appropriate fd_sets that the user passed.</p>
<p>If not, however, select() will go to sleep, for up to the maximum timeout the user specified.</p>
<p>If, during that interval, an interesting event happens to any file descriptor that select() is waiting on, that fd will notify its wait queue. That will cause the thread sleeping inside select() to wake up, at which point it will repeat the above loop and see which of the fd’s are now ready to be returned to the user.</p>
<p>select() also keeps track of all of the wait queues it has been added to, and before returning (successfully or otherwise), must go through and ensure it’s been removed from all of them.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/08/02/select-implement/" data-id="cirdiaqqq0010bsske9z0br4o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IT/">IT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/epoll/">epoll</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/select/">select</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/网络/">网络</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/08/02/outstanding-programmer/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">如何成为一位杰出的程序员</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/32-bit/">32-bit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IT/">IT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KAs/">KAs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/define/">define</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/select/">select</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/成长/">成长</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/程序员/">程序员</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络/">网络</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/32-bit/" style="font-size: 10px;">32-bit</a> <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/IT/" style="font-size: 20px;">IT</a> <a href="/tags/KAs/" style="font-size: 10px;">KAs</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/define/" style="font-size: 10px;">define</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/select/" style="font-size: 10px;">select</a> <a href="/tags/成长/" style="font-size: 16.67px;">成长</a> <a href="/tags/程序员/" style="font-size: 13.33px;">程序员</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/08/02/select-implement/">SELECT是如何实现的？</a>
          </li>
        
          <li>
            <a href="/2016/08/02/outstanding-programmer/">如何成为一位杰出的程序员</a>
          </li>
        
          <li>
            <a href="/2016/08/02/lead-the-industry/">想在IT行业牛B起来, 看他说了些什么... (年轻人必读)</a>
          </li>
        
          <li>
            <a href="/2016/08/02/programmers-10-investment/">程序员必须进行的10项投资</a>
          </li>
        
          <li>
            <a href="/2016/08/02/define-symbol/">define宏定义中的#,##,@#及\符号</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Snowyying<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>